<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-dlp 指令生成器</title>
    <style>
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: #f4f6f8; color: #333; max-width: 700px; margin: 20px auto; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: #d32f2f; margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        .checkbox-group label { display: inline-block; font-weight: normal; margin-right: 15px; cursor: pointer; }
        
        .result-area { background: #2d2d2d; color: #5ce65c; padding: 15px; border-radius: 5px; font-family: monospace; word-break: break-all; margin-top: 20px; position: relative; min-height: 60px; }
        
        .btn-copy { width: 100%; padding: 12px; background: #0078d4; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        .btn-copy:hover { background: #0064b1; }
        .btn-copy.active { background: #28a745; }

        .hint { font-size: 0.85em; color: #888; margin-top: 3px; }
    </style>
</head>
<body>

<div class="card">
    <h2>yt-dlp 指令生成器</h2>
    

    <div class="form-group">
        <label>1. yt-dlp 執行檔指令 (或路徑)</label>
        <input type="text" id="exePath" value="yt-dlp" placeholder="例如: yt-dlp 或 C:\Tools\yt-dlp.exe" oninput="generate()">
        <div class="hint">如果您有設定環境變數，填 yt-dlp 即可。</div>
    </div>

    <div class="form-group">
        <label>2. 影片網址 (URL)</label>
        <input type="text" id="url" placeholder="https://www.youtube.com/watch?v=..." oninput="generate()">
    </div>

    <div class="form-group">
        <label>3. 格式與選項</label>
        <select id="formatSelect" onchange="generate()">
            <option value="best">最佳畫質 (轉 MP4)</option>
            <option value="1080">限制 1080p (轉 MP4)</option>
            <option value="mp3">純音訊 (轉 MP3)</option>
        </select>
        <div class="checkbox-group" style="margin-top:10px;">
            <label><input type="checkbox" id="chkSubs" checked onchange="generate()"> 內嵌字幕 (中/英)</label>
            <label><input type="checkbox" id="chkThumb" checked onchange="generate()"> 內嵌封面</label>
        </div>
    </div>

    <div class="form-group">
        <label>4. 輸出資料夾 (選填)</label>
        <!-- 這裡容易出現複製路徑帶有斜線的問題 -->
        <input type="text" id="outPath" placeholder="例如: D:\Downloads (留空則下載到當前目錄)" oninput="generate()">
    </div>

    <div class="form-group">
        <label>5. 播放清單 / 檔名</label>
        <input type="text" id="playlistItems" placeholder="集數 (如: 1,3,5-10)，留空下載全部" oninput="generate()">
        <select id="filenameSelect" style="margin-top:10px;" onchange="generate()">
            <option value="%(title)s.%(ext)s">檔名: 標題</option>
            <option value="%(upload_date)s - %(title)s.%(ext)s">檔名: 日期 - 標題</option>
            <option value="%(channel)s - %(title)s.%(ext)s">檔名: 頻道 - 標題</option>
        </select>
    </div>

    <div class="result-area" id="resultBox">
        Waiting for input...
    </div>
    
    <button class="btn-copy" id="btnCopy" onclick="copyText()">複製指令</button>
</div>

<script>
    // 輔助函數：移除路徑尾端的反斜線，避免 Windows 誤判為跳脫字元
    function sanitizePath(path) {
        if (!path) return "";
        path = path.trim();
        // 如果最後一個字是 \，就把它切掉
        while (path.endsWith("\\")) {
            path = path.slice(0, -1);
        }
        return path;
    }

    function generate() {
        // 取得原始輸入
        let exe = document.getElementById('exePath').value.trim() || 'yt-dlp';
        let rawOutPath = document.getElementById('outPath').value;
        
        const url = document.getElementById('url').value.trim();
        const format = document.getElementById('formatSelect').value;
        const playlist = document.getElementById('playlistItems').value.trim();
        const filename = document.getElementById('filenameSelect').value;
        const sub = document.getElementById('chkSubs').checked;
        const thumb = document.getElementById('chkThumb').checked;

        let cmd = [];

        // 1. 處理 EXE 路徑 (移除尾端斜線並加引號)
        // 使用 sanitizePath 避免 C:\Folder\" 這種情況
        let cleanExe = sanitizePath(exe);
        if (cleanExe.includes(' ') && !cleanExe.startsWith('"')) {
            cleanExe = `"${cleanExe}"`;
        }
        cmd.push(cleanExe);

        // 2. 處理輸出路徑 (關鍵修正點)
        let cleanOutPath = sanitizePath(rawOutPath);
        if (cleanOutPath) {
            cmd.push(`-P "${cleanOutPath}"`);
        }

        // 格式
        if (format === 'mp3') {
            cmd.push('-x --audio-format mp3');
        } else if (format === '1080') {
            cmd.push('-f "bv*[height<=1080]+ba" --merge-output-format mp4');
        } else {
            cmd.push('-f "bv+ba" --merge-output-format mp4');
        }

        // 選項
        if (sub) cmd.push('--embed-subs --sub-langs "zh-Hant,en"');
        if (thumb) cmd.push('--embed-thumbnail');
        if (playlist) cmd.push(`--playlist-items ${playlist}`);
        
        // 檔名
        cmd.push(`-o "${filename}"`);

        // 網址
        if (url) {
            cmd.push(`"${url}"`);
        } else {
            // 用來提示使用者還沒貼網址
            cmd.push('"[影片網址]"');
        }

        document.getElementById('resultBox').innerText = cmd.join(' ');
    }

    function copyText() {
        const text = document.getElementById('resultBox').innerText;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.getElementById('btnCopy');
            const originalText = btn.innerText;
            btn.innerText = "已複製！";
            btn.classList.add("active");
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove("active");
            }, 2000);
        });
    }

    // 初始化
    generate();
</script>

</body>
</html>